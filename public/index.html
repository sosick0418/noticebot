<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Binance Bollinger Notice Bot - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    .card {
      @apply bg-gray-800 rounded-lg p-4 shadow-lg;
    }
    .stat-value {
      @apply text-2xl font-bold;
    }
    .stat-label {
      @apply text-gray-400 text-sm;
    }
    .long { @apply text-green-400; }
    .short { @apply text-red-400; }
    .neutral { @apply text-gray-400; }
    .positive { @apply text-green-400; }
    .negative { @apply text-red-400; }
    #chart { width: 100%; height: 400px; }
    .status-dot {
      @apply w-3 h-3 rounded-full inline-block mr-2;
    }
    .status-online { @apply bg-green-500; }
    .status-offline { @apply bg-red-500; }
    .signal-item {
      @apply flex justify-between items-center py-2 border-b border-gray-700;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Bollinger Notice Bot</h1>
      <div class="flex items-center gap-4">
        <span id="connection-status" class="flex items-center">
          <span class="status-dot status-offline"></span>
          <span>Disconnected</span>
        </span>
        <span id="symbol" class="bg-blue-600 px-3 py-1 rounded">BTCUSDT</span>
      </div>
    </header>

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <!-- Balance -->
      <div class="card">
        <div class="stat-label">Balance</div>
        <div class="stat-value" id="balance">--</div>
        <div class="text-gray-400 text-xs" id="available">Available: --</div>
      </div>

      <!-- Position -->
      <div class="card">
        <div class="stat-label">Position</div>
        <div class="stat-value" id="position-side">NONE</div>
        <div class="text-gray-400 text-xs" id="position-size">Size: --</div>
      </div>

      <!-- PNL -->
      <div class="card">
        <div class="stat-label">Unrealized PNL</div>
        <div class="stat-value" id="unrealized-pnl">--</div>
        <div class="text-xs" id="pnl-percent">--</div>
      </div>

      <!-- Mark Price -->
      <div class="card">
        <div class="stat-label">Mark Price</div>
        <div class="stat-value" id="mark-price">--</div>
        <div class="text-gray-400 text-xs" id="entry-price">Entry: --</div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Price Chart</h2>
        <div class="flex gap-2">
          <span class="text-sm text-gray-400">Bollinger Bands (20, 2)</span>
        </div>
      </div>
      <div id="chart"></div>
    </div>

    <!-- Bottom Grid -->
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Recent Signals -->
      <div class="card">
        <h2 class="text-lg font-semibold mb-4">Recent Signals</h2>
        <div id="signals-list" class="max-h-64 overflow-y-auto">
          <div class="text-gray-400 text-center py-4">No signals yet</div>
        </div>
      </div>

      <!-- System Status -->
      <div class="card">
        <h2 class="text-lg font-semibold mb-4">System Status</h2>
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-400">WebSocket</span>
            <span id="ws-status" class="neutral">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">Execution Engine</span>
            <span id="execution-status" class="neutral">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">Uptime</span>
            <span id="uptime">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">Last Update</span>
            <span id="last-update">--</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Dashboard Application
    const Dashboard = {
      ws: null,
      chart: null,
      candleSeries: null,
      upperBandSeries: null,
      middleBandSeries: null,
      lowerBandSeries: null,
      signalMarkers: [],

      init() {
        this.initChart();
        this.connectWebSocket();
        this.loadInitialData();
      },

      initChart() {
        const chartContainer = document.getElementById('chart');
        this.chart = LightweightCharts.createChart(chartContainer, {
          layout: {
            background: { color: '#1f2937' },
            textColor: '#9ca3af',
          },
          grid: {
            vertLines: { color: '#374151' },
            horzLines: { color: '#374151' },
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
          },
          timeScale: {
            timeVisible: true,
            secondsVisible: false,
          },
        });

        // Candlestick series
        this.candleSeries = this.chart.addCandlestickSeries({
          upColor: '#22c55e',
          downColor: '#ef4444',
          borderUpColor: '#22c55e',
          borderDownColor: '#ef4444',
          wickUpColor: '#22c55e',
          wickDownColor: '#ef4444',
        });

        // Bollinger Bands
        this.upperBandSeries = this.chart.addLineSeries({
          color: '#3b82f6',
          lineWidth: 1,
          lineStyle: LightweightCharts.LineStyle.Solid,
        });

        this.middleBandSeries = this.chart.addLineSeries({
          color: '#f59e0b',
          lineWidth: 1,
          lineStyle: LightweightCharts.LineStyle.Dashed,
        });

        this.lowerBandSeries = this.chart.addLineSeries({
          color: '#3b82f6',
          lineWidth: 1,
          lineStyle: LightweightCharts.LineStyle.Solid,
        });

        // Handle resize
        window.addEventListener('resize', () => {
          this.chart.applyOptions({ width: chartContainer.clientWidth });
        });
      },

      connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        this.ws = new WebSocket(wsUrl);

        this.ws.onopen = () => {
          this.updateConnectionStatus(true);
          console.log('WebSocket connected');
        };

        this.ws.onclose = () => {
          this.updateConnectionStatus(false);
          console.log('WebSocket disconnected');
          // Reconnect after 3 seconds
          setTimeout(() => this.connectWebSocket(), 3000);
        };

        this.ws.onerror = (error) => {
          console.error('WebSocket error:', error);
        };

        this.ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          this.handleMessage(message);
        };
      },

      async loadInitialData() {
        try {
          // Load initial state
          const stateRes = await fetch('/api/state');
          const state = await stateRes.json();

          // Update UI with initial data
          if (state.candles && state.candles.length > 0) {
            const chartData = state.candles.map(c => ({
              time: c.time / 1000,
              open: c.open,
              high: c.high,
              low: c.low,
              close: c.close,
            }));
            this.candleSeries.setData(chartData);
          }

          if (state.bollingerBands && state.bollingerBands.length > 0) {
            this.upperBandSeries.setData(state.bollingerBands.map(b => ({
              time: b.time / 1000,
              value: b.upper,
            })));
            this.middleBandSeries.setData(state.bollingerBands.map(b => ({
              time: b.time / 1000,
              value: b.middle,
            })));
            this.lowerBandSeries.setData(state.bollingerBands.map(b => ({
              time: b.time / 1000,
              value: b.lower,
            })));
          }

          if (state.position) {
            this.updatePosition(state.position);
          }

          if (state.account) {
            this.updateAccount(state.account);
          }

          if (state.signals && state.signals.length > 0) {
            state.signals.forEach(s => this.addSignalToList(s));
          }

          this.updateSystemStatus(state.status);
        } catch (error) {
          console.error('Failed to load initial data:', error);
        }
      },

      handleMessage(message) {
        switch (message.type) {
          case 'candle':
            this.updateCandle(message.data);
            break;
          case 'bollingerBands':
            this.updateBollingerBands(message.data);
            break;
          case 'position':
            this.updatePosition(message.data);
            break;
          case 'account':
            this.updateAccount(message.data);
            break;
          case 'signal':
            this.addSignalToList(message.data);
            this.addSignalMarker(message.data);
            break;
          case 'status':
            this.updateSystemStatus(message.data);
            break;
        }
      },

      updateCandle(candle) {
        this.candleSeries.update({
          time: candle.time / 1000,
          open: candle.open,
          high: candle.high,
          low: candle.low,
          close: candle.close,
        });
        document.getElementById('mark-price').textContent = this.formatPrice(candle.close);
      },

      updateBollingerBands(bands) {
        this.upperBandSeries.update({ time: bands.time / 1000, value: bands.upper });
        this.middleBandSeries.update({ time: bands.time / 1000, value: bands.middle });
        this.lowerBandSeries.update({ time: bands.time / 1000, value: bands.lower });
      },

      updatePosition(position) {
        if (!position || position.side === 'NONE') {
          document.getElementById('position-side').textContent = 'NONE';
          document.getElementById('position-side').className = 'stat-value neutral';
          document.getElementById('position-size').textContent = 'Size: --';
          document.getElementById('unrealized-pnl').textContent = '--';
          document.getElementById('unrealized-pnl').className = 'stat-value neutral';
          document.getElementById('pnl-percent').textContent = '--';
          document.getElementById('entry-price').textContent = 'Entry: --';
          return;
        }

        const isLong = position.side === 'LONG';
        document.getElementById('position-side').textContent = position.side;
        document.getElementById('position-side').className = `stat-value ${isLong ? 'long' : 'short'}`;
        document.getElementById('position-size').textContent = `Size: ${position.size} (${position.leverage}x)`;
        document.getElementById('unrealized-pnl').textContent = this.formatUsd(position.unrealizedPnl);
        document.getElementById('unrealized-pnl').className = `stat-value ${position.unrealizedPnl >= 0 ? 'positive' : 'negative'}`;
        document.getElementById('pnl-percent').textContent = `${position.unrealizedPnlPercent >= 0 ? '+' : ''}${position.unrealizedPnlPercent.toFixed(2)}%`;
        document.getElementById('pnl-percent').className = position.unrealizedPnlPercent >= 0 ? 'positive text-xs' : 'negative text-xs';
        document.getElementById('entry-price').textContent = `Entry: ${this.formatPrice(position.entryPrice)}`;
        document.getElementById('mark-price').textContent = this.formatPrice(position.markPrice);
      },

      updateAccount(account) {
        document.getElementById('balance').textContent = this.formatUsd(account.balance);
        document.getElementById('available').textContent = `Available: ${this.formatUsd(account.available)}`;
      },

      addSignalToList(signal) {
        const list = document.getElementById('signals-list');
        // Clear "No signals" message
        if (list.querySelector('.text-center')) {
          list.innerHTML = '';
        }

        const item = document.createElement('div');
        item.className = 'signal-item';
        item.innerHTML = `
          <div>
            <span class="${signal.type === 'LONG' ? 'long' : 'short'} font-semibold">${signal.type}</span>
            <span class="text-gray-400 text-sm ml-2">${this.formatPrice(signal.price)}</span>
          </div>
          <div class="text-right">
            <span class="text-xs ${signal.executed ? 'text-green-400' : 'text-gray-500'}">
              ${signal.executed ? 'Executed' : 'Signal Only'}
            </span>
            <div class="text-gray-500 text-xs">${this.formatTime(signal.timestamp)}</div>
          </div>
        `;
        list.insertBefore(item, list.firstChild);

        // Keep max 20 items
        while (list.children.length > 20) {
          list.removeChild(list.lastChild);
        }
      },

      addSignalMarker(signal) {
        const markers = this.candleSeries.markers() || [];
        markers.push({
          time: signal.timestamp / 1000,
          position: signal.type === 'LONG' ? 'belowBar' : 'aboveBar',
          color: signal.type === 'LONG' ? '#22c55e' : '#ef4444',
          shape: signal.type === 'LONG' ? 'arrowUp' : 'arrowDown',
          text: signal.type,
        });
        this.candleSeries.setMarkers(markers.slice(-50));
      },

      updateSystemStatus(status) {
        document.getElementById('ws-status').textContent = status.isConnected ? 'Connected' : 'Disconnected';
        document.getElementById('ws-status').className = status.isConnected ? 'positive' : 'negative';

        const execText = status.executionEnabled
          ? (status.executionReady ? 'Ready' : 'Initializing')
          : 'Disabled';
        document.getElementById('execution-status').textContent = execText;
        document.getElementById('execution-status').className = status.executionReady ? 'positive' : 'neutral';

        document.getElementById('uptime').textContent = this.formatDuration(status.uptime);
        document.getElementById('last-update').textContent = this.formatTime(status.lastUpdate);
      },

      updateConnectionStatus(connected) {
        const el = document.getElementById('connection-status');
        const dot = el.querySelector('.status-dot');
        const text = el.querySelector('span:last-child');

        if (connected) {
          dot.className = 'status-dot status-online';
          text.textContent = 'Connected';
        } else {
          dot.className = 'status-dot status-offline';
          text.textContent = 'Disconnected';
        }
      },

      formatPrice(price) {
        return price ? `$${price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '--';
      },

      formatUsd(amount) {
        if (amount === null || amount === undefined) return '--';
        const prefix = amount >= 0 ? '' : '-';
        return `${prefix}$${Math.abs(amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      },

      formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString();
      },

      formatDuration(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);

        if (hours > 0) {
          return `${hours}h ${minutes % 60}m`;
        } else if (minutes > 0) {
          return `${minutes}m ${seconds % 60}s`;
        }
        return `${seconds}s`;
      },
    };

    // Initialize dashboard when DOM is ready
    document.addEventListener('DOMContentLoaded', () => Dashboard.init());
  </script>
</body>
</html>
